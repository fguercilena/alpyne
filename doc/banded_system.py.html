
<html>
    <head>
        <title> banded_system.py </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">

        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6">
        </script>
        <script id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
        </script>

        <link rel="stylesheet" href="colorful.css" type="text/css">
    </head>

    <body>

        <h1> banded_system.py </h1>

        <p class="intro">
            Stuff for banded matrices.
        </p>

        <table style="width:100%">
            
<tr>
    <td style="vertical-align: top" class="explanation">
        
    </td>
    <td style="vertical-align: top">
        <div class="highlight"><pre><span></span><a name="line-1"></a><span class="lineno">   1 </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn"><a href="banded_system.py.html#line-1">np</a></span><br><a name="line-2"></a><span class="lineno">   2 </span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span><br><a name="line-3"></a><span class="lineno">   3 </span><br><a name="line-4"></a><span class="lineno">   4 </span><br></pre></div>

    </td>
</tr>

<tr>
    <td style="vertical-align: top" class="explanation">
        Convenience function: it takes a banded matrix \(A\) with upper bandwidth<br>\(u\) and lower bandwidth \(l\) in the usual, dense form, and returns the<br>equivalent matrix \(B\) in diagonal storage form, according to the element<br>correspondence rule \(a_{ij}=b_{j - i + l, j}\).
    </td>
    <td style="vertical-align: top">
        <div class="highlight"><pre><span></span><a name="line-9"></a><span class="lineno">   9 </span><span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><br><a name="line-10"></a><span class="lineno">  10 </span><span class="k">def</span> <span class="nf"><a href="banded_system.py.html#line-10">pack</a></span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span><br><a name="line-11"></a><span class="lineno">  11 </span><br><a name="line-12"></a><span class="lineno">  12 </span>    <span class="n">n</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><br><a name="line-13"></a><span class="lineno">  13 </span><br><a name="line-14"></a><span class="lineno">  14 </span>    <span class="n">B</span> <span class="o">=</span> <span class="n"><a href="banded_system.py.html#line-1">np</a></span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">l</span> <span class="o">+</span> <span class="n">u</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n"><a href="banded_system.py.html#line-1">np</a></span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><br><a name="line-15"></a><span class="lineno">  15 </span><br><a name="line-16"></a><span class="lineno">  16 </span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span><br><a name="line-17"></a><span class="lineno">  17 </span>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">l</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">u</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)):</span><br><a name="line-18"></a><span class="lineno">  18 </span>            <span class="n">B</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="n">i</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><br><a name="line-19"></a><span class="lineno">  19 </span><br><a name="line-20"></a><span class="lineno">  20 </span>    <span class="k">return</span> <span class="n">B</span><br><a name="line-21"></a><span class="lineno">  21 </span><br><a name="line-22"></a><span class="lineno">  22 </span><br></pre></div>

    </td>
</tr>

<tr>
    <td style="vertical-align: top" class="explanation">
        Convenience function, the inverse of <code>pack</code> above: takes a matrix<br>in diagonal storage form and unpacks it in normal dense storage.
    </td>
    <td style="vertical-align: top">
        <div class="highlight"><pre><span></span><a name="line-25"></a><span class="lineno">  25 </span><span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><br><a name="line-26"></a><span class="lineno">  26 </span><span class="k">def</span> <span class="nf"><a href="banded_system.py.html#line-26">unpack</a></span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span><br><a name="line-27"></a><span class="lineno">  27 </span><br><a name="line-28"></a><span class="lineno">  28 </span>    <span class="n">n</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><br><a name="line-29"></a><span class="lineno">  29 </span><br><a name="line-30"></a><span class="lineno">  30 </span>    <span class="n">A</span> <span class="o">=</span> <span class="n"><a href="banded_system.py.html#line-1">np</a></span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n"><a href="banded_system.py.html#line-1">np</a></span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><br><a name="line-31"></a><span class="lineno">  31 </span><br><a name="line-32"></a><span class="lineno">  32 </span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="n">u</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span><br><a name="line-33"></a><span class="lineno">  33 </span>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">l</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)):</span><br><a name="line-34"></a><span class="lineno">  34 </span>            <span class="n">A</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="n">i</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><br><a name="line-35"></a><span class="lineno">  35 </span><br><a name="line-36"></a><span class="lineno">  36 </span>    <span class="k">return</span> <span class="n">A</span><br><a name="line-37"></a><span class="lineno">  37 </span><br><a name="line-38"></a><span class="lineno">  38 </span><br></pre></div>

    </td>
</tr>

<tr>
    <td style="vertical-align: top" class="explanation">
        Pre-process a matrix in diagonal storage, computing its LDU decomposition in<br>the form necessary to implement the Thomas algorithm without divisions. The<br>matrix is modified in place (i.e. the LDU decomposition is stored in the<br>same array, no memory allocation is performed).
    </td>
    <td style="vertical-align: top">
        <div class="highlight"><pre><span></span><a name="line-43"></a><span class="lineno">  43 </span><span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><br><a name="line-44"></a><span class="lineno">  44 </span><span class="k">def</span> <span class="nf"><a href="banded_system.py.html#line-44">preprocess_matrix</a></span><span class="p">(</span><span class="n">A</span><span class="p">):</span><br><a name="line-45"></a><span class="lineno">  45 </span><br><a name="line-46"></a><span class="lineno">  46 </span>    <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><br><a name="line-47"></a><span class="lineno">  47 </span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><br></pre></div>

    </td>
</tr>

<tr>
    <td style="vertical-align: top" class="explanation">
        This is formula just before formula 3.56 in QSS
    </td>
    <td style="vertical-align: top">
        <div class="highlight"><pre><span></span><a name="line-49"></a><span class="lineno">  49 </span>        <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span><br><a name="line-50"></a><span class="lineno">  50 </span><br><a name="line-51"></a><span class="lineno">  51 </span><br></pre></div>

    </td>
</tr>

<tr>
    <td style="vertical-align: top" class="explanation">
        Takes the LDU decompsition of a matrix in diagonal storage (as computed by<br><code>preprocess_matrix</code>) and an arbitrary number of RHS vectors,<br>and computes the solution to each linear system by performing the relevant<br>back- and forward substitutions. The solution vector(s) is updated in place.
    </td>
    <td style="vertical-align: top">
        <div class="highlight"><pre><span></span><a name="line-56"></a><span class="lineno">  56 </span><span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><br><a name="line-57"></a><span class="lineno">  57 </span><span class="k">def</span> <span class="nf"><a href="banded_system.py.html#line-57">fb_substitution</a></span><span class="p">(</span><span class="n">LU</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span><br><a name="line-58"></a><span class="lineno">  58 </span><br><a name="line-59"></a><span class="lineno">  59 </span>    <span class="n">n_eqs</span><span class="p">,</span> <span class="n">n_sources</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><br><a name="line-60"></a><span class="lineno">  60 </span><br><a name="line-61"></a><span class="lineno">  61 </span>    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sources</span><span class="p">):</span><br><a name="line-62"></a><span class="lineno">  62 </span><br></pre></div>

    </td>
</tr>

<tr>
    <td style="vertical-align: top" class="explanation">
        This loop is the first line of formula 3.56 of QSS
    </td>
    <td style="vertical-align: top">
        <div class="highlight"><pre><span></span><a name="line-64"></a><span class="lineno">  64 </span>        <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">LU</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span><br><a name="line-65"></a><span class="lineno">  65 </span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_eqs</span><span class="p">):</span><br><a name="line-66"></a><span class="lineno">  66 </span>            <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">LU</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">LU</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span><br><a name="line-67"></a><span class="lineno">  67 </span><br></pre></div>

    </td>
</tr>

<tr>
    <td style="vertical-align: top" class="explanation">
        This loop is the second line of formula 3.56 of QSS
    </td>
    <td style="vertical-align: top">
        <div class="highlight"><pre><span></span><a name="line-69"></a><span class="lineno">  69 </span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_eqs</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span><br><a name="line-70"></a><span class="lineno">  70 </span>            <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">-=</span> <span class="n">LU</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">LU</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span><br><a name="line-71"></a><span class="lineno">  71 </span><br><a name="line-72"></a><span class="lineno">  72 </span><br></pre></div>

    </td>
</tr>

        </table>

    </body>

</html>
